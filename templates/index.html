
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>たぴテトリス</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #2a2a3f);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    canvas {
      background: #222;
      border: 4px solid #fcd34d;
      box-shadow: 0 0 20px #fcd34d;
      display: none;
      margin-top: 10px;
    }
    #menu {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
    }
    button {
      padding: 10px 20px;
      font-size: 1.1rem;
      border: none;
      border-radius: 10px;
      background: #fcd34d;
      color: #000;
      cursor: pointer;
      width: 100%;
    }
    #nicknameModal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #nicknameModal input, #friendInput, #chatInput {
      padding: 10px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      width: 80%;
      max-width: 300px;
      margin-bottom: 10px;
    }
    #score {
      font-size: 1.2rem;
      margin-top: 10px;
      display: none;
    }
    #friendPanel, #chat {
      margin-top: 10px;
      width: 100%;
      max-width: 320px;
    }
    #chatLog {
      background: #333;
      border-radius: 8px;
      padding: 10px;
      height: 150px;
      overflow-y: auto;
      font-size: 0.9rem;
    }
    #friendList {
      list-style: none;
      padding: 0;
    }
    #friendList li {
      display: flex;
      justify-content: space-between;
      background: rgba(255,255,255,0.05);
      padding: 6px 10px;
      margin-top: 4px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="nicknameModal">
    <p>ニックネームを入力</p>
    <input id="nicknameInput" type="text" placeholder="Tapi..." />
    <button onclick="saveNickname()">OK</button>
  </div>

  <div id="menu">
    <p id="highScoreLabel">最高スコア: 0</p>
    <button onclick="toggleFriendUI()">フレンド</button>
    <div id="friendPanel" style="display:none;">
      フレンドID（自分）：<span id="myFriendId"></span><br/>
      <input id="friendInput" placeholder="フレンドのID" />
      <button onclick="addFriend()">フレンド追加</button>
      <ul id="friendList"></ul>
    </div>

    <h1>たぴテトリス</h1>
    <p id="nicknameLabel"></p>
    <button onclick="startGame()">ソロプレイ</button>
    <button onclick="openMatch()">オンライン対戦</button>
    <button disabled>世界ランキング（準備中）</button>
    <button onclick="resetNickname()">ニックネーム変更</button>
  </div>

  <canvas id="tetris" width="240" height="400"></canvas>
  <div id="score">スコア: <span id="scoreValue">0</span></div>

  <div id="chat">
    <div id="chatLog"></div>
    <input id="chatInput" placeholder="チャットを入力..." />
    <button onclick="sendChat()">送信</button>
  </div>

<script>
let socket;
let opponentMatrix = null;
let highScore = Number(localStorage.getItem('highScore') || 0);
let score = 0;
const nicknameModal = document.getElementById('nicknameModal');
const nicknameInput = document.getElementById('nicknameInput');
const nicknameLabel = document.getElementById('nicknameLabel');
const scoreValue = document.getElementById('scoreValue');
document.getElementById('highScoreLabel').textContent = '最高スコア: ' + highScore;

function saveNickname() {
  const name = nicknameInput.value.trim();
  if (name) {
    localStorage.setItem('nickname', name);
    nicknameModal.style.display = 'none';
    nicknameLabel.textContent = 'こんにちは、' + name + ' さん！';
  }
}
function resetNickname() {
  localStorage.removeItem('nickname');
  location.reload();
}
const savedName = localStorage.getItem('nickname');
if (savedName) {
  nicknameModal.style.display = 'none';
  nicknameLabel.textContent = 'こんにちは、' + savedName + ' さん！';
}

function updateScore(val) {
  score += val;
  scoreValue.textContent = score;
}

function toggleFriendUI() {
  const p = document.getElementById("friendPanel");
  p.style.display = p.style.display === "none" ? "block" : "none";
}
const myFriendId = Math.random().toString(36).substring(2, 8);
document.getElementById('myFriendId').textContent = myFriendId;
function addFriend() {
  const friendId = document.getElementById('friendInput').value.trim();
  if (!friendId) return;
  let friends = JSON.parse(localStorage.getItem('friends') || '[]');
  if (!friends.includes(friendId)) {
    friends.push(friendId);
    localStorage.setItem('friends', JSON.stringify(friends));
    renderFriendList();
  }
}
function renderFriendList() {
  const list = document.getElementById('friendList');
  list.innerHTML = '';
  const friends = JSON.parse(localStorage.getItem('friends') || '[]');
  friends.forEach(f => {
    const li = document.createElement('li');
    const joinBtn = document.createElement('button');
    joinBtn.textContent = '対戦';
    joinBtn.onclick = () => {
      connectToMatch(f);
      startGame();
    };
    li.textContent = f + ' ';
    li.appendChild(joinBtn);
    list.appendChild(li);
  });
}
renderFriendList();
function openMatch() {
  const matchId = prompt("マッチIDを入力（空でランダム）:");
  const id = matchId || Math.random().toString(36).substring(2, 8);
  connectToMatch(id);
  startGame();
}
function connectToMatch(roomId) {
  socket = new WebSocket("ws://localhost:8080");
  socket.addEventListener('open', () => {
    socket.send(JSON.stringify({ type: 'join', roomId }));
  });
  socket.addEventListener('message', (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'start') alert("対戦開始！");
    if (data.type === 'opponent') opponentMatrix = data.matrix;
    if (data.type === 'chat') {
      const chatLog = document.getElementById('chatLog');
      const p = document.createElement('p');
      p.textContent = `${data.nickname}: ${data.message}`;
      chatLog.appendChild(p);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
  });
}
function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg || !socket || socket.readyState !== WebSocket.OPEN) return;
  const name = localStorage.getItem('nickname') || '匿名';
  socket.send(JSON.stringify({ type: 'chat', nickname: name, message: msg }));
  input.value = '';
}
</script>
</body>
</html>
